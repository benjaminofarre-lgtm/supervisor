<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surfland Manager 22.0 (Online)</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2909/2909803.png">
    
    <style>
        :root { --primary: #0277bd; --secondary: #00838f; --accent: #f9a825; --bg: #f4f7f6; --text: #263238; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        /* DIAGNOSTIC LOADING */
        #loadingMask { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center;
        }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #errorLog {
            margin-top: 20px; color: #c62828; background: #ffebee; padding: 15px; 
            border: 1px solid #ef5350; border-radius: 5px; font-family: monospace; 
            max-width: 90%; display: none; text-align: left; font-size: 0.9em;
        }

        /* OTRAS ESTILOS */
        #loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, var(--primary), var(--secondary)); position: fixed; width: 100%; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #cfd8dc; border-radius: 6px; box-sizing:border-box;}
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn-login:hover { transform: translateY(-2px); }
        
        #appScreen { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 80px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .controls { background: white; padding: 20px; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; border-left: 5px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-secondary { background: #546e7a; color: white; }
        .btn-info { background: #0288d1; color: white; }

        .schedule-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .team-banner { text-align: center; padding: 20px; color: white; font-size: 1.8em; font-weight: 800; text-transform: uppercase; }
        .bg-kirra { background: linear-gradient(45deg, #1976d2, #42a5f5); }
        .bg-mundaka { background: linear-gradient(45deg, #388e3c, #66bb6a); }
        .bg-locked { background: #757575; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background: #fafafa; color: #546e7a; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; }
        .row-disabled { opacity: 0.6; background: #fafafa; }
        
        /* Inputs Tabela */
        .editable-name { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .status-select { padding: 6px; border-radius: 4px; font-weight: bold; width: 130px; border: 1px solid #ddd; }
        .status-fixo { background: #e8f5e9; color: #2e7d32; }
        .status-rotativo { background: #e3f2fd; color: #1565c0; }
        .status-free { background: #fff3e0; color: #ef6c00; }
        .check-status { transform: scale(1.3); cursor: pointer; accent-color: #2e7d32; }

        .panel { display: none; position: fixed; top: 0; right: 0; width: 850px; height: 100%; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.2); z-index: 100; overflow-y: auto; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 99; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #ddd; }
        .panel-content { padding: 20px; }
        
        .list-row { display: flex; align-items: center; margin-bottom: 8px; gap: 5px; }
        .list-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-trash { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; border-radius: 4px; padding: 5px 10px; cursor: pointer; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        #lockedMessage { display: none; background: #ffebee; color: #c62828; padding: 10px; border-radius: 6px; margin-top: 10px; font-weight: bold; text-align: center; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>

    <div id="loadingMask">
        <div class="spinner"></div>
        <h3 id="loadingText" style="margin-top:20px; color:#555;">Conectando ao Google...</h3>
        <div id="errorLog"></div>
        <button id="btnCloseLoad" style="display:none; margin-top:20px; background:#c62828; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;" onclick="closeLoading()">FECHAR E TENTAR OFFLINE</button>
    </div>

    <div id="loginScreen" style="display:none;">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:5px;">SURFLAND</h2>
            <p style="margin-top:0; color:#777;">Gest√£o Online v22.0</p>
            <div id="loginError" style="color: #d32f2f; background:#ffebee; padding:10px; border-radius:4px; font-size: 0.9em; display: none; margin-bottom: 15px;">Login Incorreto</div>
            <input type="text" id="userInput" placeholder="Usu√°rio">
            <input type="password" id="passInput" placeholder="Senha">
            <button class="btn-login" onclick="window.attemptLogin()">ENTRAR (SUPERVISOR)</button>
            <button class="btn-login" style="background:#546e7a" onclick="window.staffLogin()">VISUALIZAR</button>
        </div>
    </div>

    <div id="appScreen">
        <div class="header-bar">
            <h2 style="margin:0; color:var(--primary);">Organizador</h2>
            <span onclick="location.reload()" style="cursor:pointer; color:#c62828; font-weight:bold;">Sair</span>
        </div>

        <div class="controls">
            <div style="flex-grow: 1;">
                <label style="font-weight:bold;">üìÖ Data:</label>
                <input type="date" id="datePicker" onchange="window.changeDate()" style="padding:10px; border-radius:6px; border:1px solid #ccc; font-family:inherit;">
                <div id="lockedMessage">üîí DATA PASSADA - APENAS LEITURA</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-info" onclick="window.openPanel('statsPanel')">üìä Placar</button>
                <div id="adminControls" style="display:none; gap:10px;">
                    <button id="btnSave" class="btn-success" onclick="window.saveCurrentDay()">üíæ SALVAR TUDO</button>
                    <button class="btn-secondary" onclick="window.openPanel('configPanel')">‚öôÔ∏è Configurar</button>
                </div>
            </div>
        </div>

        <div class="schedule-container">
            <div id="teamBanner" class="team-banner">...</div>
            <table id="scheduleTable">
                <thead><tr><th width="50">OK</th><th width="150">Fun√ß√£o</th><th>Colaborador</th><th width="140">Status</th></tr></thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="window.closeAllPanels()"></div>
    <div id="statsPanel" class="panel"><div class="panel-header"><h3>üìä Placar de Justi√ßa</h3><button onclick="window.closeAllPanels()">√ó</button></div><div class="panel-content" id="statsContent"></div></div>

    <div id="configPanel" class="panel">
        <div class="panel-header"><h3>üë• Configura√ß√£o de Equipes</h3><button onclick="window.closeAllPanels()">√ó</button></div>
        <div class="panel-content">
            <button class="btn-success" style="width:100%; margin-bottom:20px; padding:15px;" onclick="window.saveConfigToFirebase()">üíæ SALVAR NO FIREBASE E ATUALIZAR TELA</button>
            <div class="config-grid">
                <div style="border-right:1px dashed #ccc; padding-right:10px;">
                    <h3 style="color:#0277bd; margin-top:0;">üîµ KIRRA</h3>
                    <b style="display:block; margin-top:10px;">Guias Fixos:</b><div id="listKirraGuides"></div>
                    <b style="display:block; margin-top:10px;">GVs Fixos:</b><div id="listKirraGVs"></div>
                    <b style="display:block; margin-top:10px;">Rotativos:</b><div id="listKirraRot"></div>
                </div>
                <div>
                    <h3 style="color:#2e7d32; margin-top:0;">üü¢ MUNDAKA</h3>
                    <b style="display:block; margin-top:10px;">Guias Fixos:</b><div id="listMundakaGuides"></div>
                    <b style="display:block; margin-top:10px;">GVs Fixos:</b><div id="listMundakaGVs"></div>
                    <b style="display:block; margin-top:10px;">Rotativos:</b><div id="listMundakaRot"></div>
                </div>
            </div>
            <hr style="margin:20px 0;">
            <h4 style="margin-bottom:5px;">üü† Freelancers (Banco)</h4>
            <div id="listFreelancers" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =================================================================
        // ‚úÖ CLAVES INTEGRADAS CORRECTAMENTE
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAF1d4Uk8-cg4vXwbHLmtg_Kzg6bvCYqaU",
            authDomain: "programa-de-escalas.firebaseapp.com",
            projectId: "programa-de-escalas",
            storageBucket: "programa-de-escalas.firebasestorage.app",
            messagingSenderId: "693139321340",
            appId: "1:693139321340:web:55d3b0f4af39ccf6078279"
        };
        // =================================================================

        let app, db;
        let appConfig = getDefaultData();
        let currentDayData = [];
        let isAdmin = false;
        let isLocked = false;
        const BASE_DATE = new Date(2026, 0, 4);

        // Fun√ß√µes Globais de Ajuda
        window.closeLoading = () => { document.getElementById('loadingMask').style.display = 'none'; };
        
        function showError(msg) {
            const log = document.getElementById('errorLog');
            const btn = document.getElementById('btnCloseLoad');
            const txt = document.getElementById('loadingText');
            txt.innerText = "Falha na Conex√£o";
            txt.style.color = "red";
            log.style.display = 'block';
            log.innerHTML = `<strong>ERRO:</strong> ${msg}<br><br>Poss√≠veis causas:<br>1. Banco de Dados n√£o criado.<br>2. Regras de seguran√ßa bloqueadas (Coloque em 'Test Mode').`;
            btn.style.display = 'block';
        }

        // --- INICIALIZA√á√ÉO ---
        window.addEventListener('load', async () => {
            const today = new Date();
            document.getElementById('datePicker').value = today.toISOString().split('T')[0];

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Timeout de seguran√ßa: 5s
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Tempo limite excedido. O Firebase n√£o respondeu.")), 5000));
                
                // Tenta ler configura√ß√£o
                const docRef = doc(db, "settings", "teams");
                const docSnap = await Promise.race([getDoc(docRef), timeout]);

                if (docSnap.exists()) appConfig = docSnap.data();
                else await setDoc(docRef, appConfig); // Cria se n√£o existe

                document.getElementById('loadingMask').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';

            } catch (e) {
                console.error(e);
                showError(e.message);
                // Permite usar offline com dados padr√£o se falhar
                document.getElementById('btnCloseLoad').style.display = 'block';
            }
        });

        // --- SALVAR CONFIG ---
        window.saveConfigToFirebase = async function() {
            document.getElementById('loadingMask').style.display = 'flex';
            document.getElementById('loadingText').innerText = "Salvando...";
            document.getElementById('errorLog').style.display = 'none';
            
            try {
                // Timeout de 5s
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Demorou muito para salvar.")), 5000));
                
                await Promise.race([
                    setDoc(doc(db, "settings", "teams"), appConfig),
                    timeout
                ]);

                // For√ßa recalcular dia atual com novos nomes
                const dateStr = document.getElementById('datePicker').value;
                if(dateStr && !isLocked) {
                    currentDayData = generateMathSchedule(dateStr); 
                    await setDoc(doc(db, "days", dateStr), { entries: currentDayData });
                    renderTable(currentDayData, dateStr, isLocked);
                }
                
                alert("‚úÖ Salvo com sucesso!");
                window.closeAllPanels();
                
            } catch(e) {
                showError(e.message);
            }
            document.getElementById('loadingMask').style.display = 'none';
        };

        // --- RESTO DO SISTEMA ---
        window.attemptLogin = function() {
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            if(u==="SUPERVISORSURFLAND" && p==="meupapitobenja") { isAdmin=true; showApp(); }
            else document.getElementById('loginError').style.display='block';
        };
        window.staffLogin = () => { isAdmin=false; showApp(); };

        function showApp() {
            document.getElementById('loginScreen').style.display='none';
            document.getElementById('appScreen').style.display='block';
            if(isAdmin) document.getElementById('adminControls').style.display='flex';
            window.changeDate();
        }

        window.changeDate = async function() {
            const dateStr = document.getElementById('datePicker').value;
            if(!dateStr) return;
            const parts = dateStr.split('-');
            const selDate = new Date(parts[0], parts[1]-1, parts[2]); // Data correta sem fuso
            const today = new Date(); today.setHours(0,0,0,0);
            
            isLocked = (selDate < today); 
            document.getElementById('lockedMessage').style.display = isLocked ? 'block' : 'none';
            if(document.getElementById('btnSave')) document.getElementById('btnSave').disabled = isLocked;

            // 1. Gera localmente (instant√¢neo)
            currentDayData = generateMathSchedule(dateStr);
            renderTable(currentDayData, dateStr, isLocked);

            // 2. Busca do banco (ass√≠ncrono)
            if(db) {
                try {
                    const snap = await getDoc(doc(db, "days", dateStr));
                    if(snap.exists()) {
                        currentDayData = snap.data().entries;
                        renderTable(currentDayData, dateStr, isLocked);
                    }
                } catch(e) { console.log("Erro ao buscar dia:", e); }
            }
        };

        // --- L√ìGICA DE ROTA√á√ÉO (LIQUIDIFICADOR v20) ---
        function generateMathSchedule(dateStr) {
            const parts = dateStr.split('-');
            const d = new Date(parts[0], parts[1]-1, parts[2]);
            const oneDay = 24 * 60 * 60 * 1000;
            const diffTime = Math.floor((d - BASE_DATE) / oneDay);
            
            const isKirra = (Math.abs(diffTime) % 2) === 0;
            const shiftIdx = Math.floor(Math.abs(diffTime) / 2);

            const listG = isKirra ? (appConfig.kirraGuides||[]) : (appConfig.mundakaGuides||[]);
            const listGV = isKirra ? (appConfig.kirraGVs||[]) : (appConfig.mundakaGVs||[]);
            const listRot = isKirra ? (appConfig.kirraRot||[]) : (appConfig.mundakaRot||[]);
            const listFree = appConfig.freelancers || [];

            let schedule = [], guidePool = [], gvTotalPool = [];

            // 1. GUIAS (8 Vagas)
            listG.forEach(n => guidePool.push({n, s:"FIXO"}));
            const gNeed = 8 - guidePool.length;
            const rotOffset = (shiftIdx * gNeed) % Math.max(1, listRot.length);
            for(let i=0; i<gNeed; i++) {
                let idx = (rotOffset + i) % listRot.length;
                guidePool.push({n: listRot[idx], s:"ROTATIVO"});
            }
            guidePool = rotate(guidePool, shiftIdx); // Carrossel Guias
            for(let i=0; i<8; i++) schedule.push({role:`Guide ${i+1}`, name:guidePool[i]?.n||"VAGA", status:guidePool[i]?.s||"ROTATIVO", active:true});

            // 2. GVs (12 Vagas - Liquidificador Total)
            listGV.forEach(n => gvTotalPool.push({n, s:"FIXO"})); // GVs Fixos
            
            const rotRem = listRot.length - gNeed; // Rotativos que sobraram
            for(let i=0; i<rotRem; i++) {
                let idx = (rotOffset + gNeed + i) % listRot.length;
                gvTotalPool.push({n: listRot[idx], s:"ROTATIVO"});
            }
            
            const gvSoFar = gvTotalPool.length; // Freelancers completam
            const freeNeed = 12 - gvSoFar;
            if(freeNeed > 0) {
                const fOff = (Math.abs(diffTime) * freeNeed) % Math.max(1, listFree.length);
                for(let i=0; i<freeNeed; i++) {
                    let idx = (fOff + i) % listFree.length;
                    gvTotalPool.push({n: listFree[idx], s:"FREELANCER"});
                }
            }
            
            gvTotalPool = rotate(gvTotalPool, shiftIdx); // Carrossel TOTAL (GVs 1-12)
            
            for(let i=0; i<12; i++) {
                schedule.push({role:`Guarda-Vidas ${i+1}`, name:gvTotalPool[i]?.n||"VAGA", status:gvTotalPool[i]?.s||"FREE", active:true});
            }

            return schedule;
        }

        function rotate(arr, n) { if(!arr.length) return []; const k=n%arr.length; return arr.slice(arr.length-k).concat(arr.slice(0, arr.length-k)); }

        function renderTable(data, dateStr, isLocked) {
            const body = document.getElementById('scheduleBody'); body.innerHTML = "";
            const parts = dateStr.split('-');
            const d = new Date(parts[0], parts[1]-1, parts[2]);
            const isKirra = (Math.abs(Math.floor((d - BASE_DATE)/(86400000))) % 2) === 0;
            
            const banner = document.getElementById('teamBanner');
            if(isLocked) { banner.textContent="HIST√ìRICO BLOQUEADO"; banner.className="team-banner bg-locked"; }
            else { banner.textContent=isKirra?"Equipe: KIRRA":"Equipe: MUNDAKA"; banner.className=isKirra?"team-banner bg-kirra":"team-banner bg-mundaka"; }

            data.forEach((e, i) => {
                const tr = document.createElement('tr');
                if(!e.active) tr.classList.add('row-disabled');
                const dis = isLocked ? "disabled" : "";
                
                const chk = isAdmin ? `<input type="checkbox" class="check-status" ${e.active?'checked':''} onchange="window.upd(${i}, 'active', this.checked)" ${dis}>` : (e.active?'‚úÖ':'‚ùå');
                const inp = isAdmin ? `<input class="editable-name" value="${e.name}" onchange="window.upd(${i}, 'name', this.value)" ${dis}>` : `<b>${e.name}</b>`;
                const sel = isAdmin ? `<select class="status-select status-${e.status.toLowerCase()}" onchange="window.upd(${i}, 'status', this.value)" ${dis}><option value="FIXO" ${e.status=='FIXO'?'selected':''}>FIXO</option><option value="ROTATIVO" ${e.status=='ROTATIVO'?'selected':''}>ROTATIVO</option><option value="FREELANCER" ${e.status=='FREELANCER'?'selected':''}>FREELANCER</option></select>` : `<span>${e.status}</span>`;
                
                const roleClass = e.role.includes("Guide") ? "role-guia" : "role-gv";
                tr.innerHTML = `<td>${chk}</td><td class="${roleClass}"><b>${e.role}</b></td><td>${inp}</td><td>${sel}</td>`;
                body.appendChild(tr);
            });
        }

        window.upd = (i, f, v) => { currentDayData[i][f] = v; };

        // Painel Config e Stats
        window.openPanel = async (id) => {
            document.getElementById(id).style.display='block'; document.getElementById('overlay').style.display='block';
            if(id==='configPanel') renderCfg();
            if(id==='statsPanel') {
                const div = document.getElementById('statsContent'); div.innerHTML="Carregando...";
                if(!db) return div.innerHTML="Sem conex√£o.";
                const snap = await getDocs(collection(db,"days"));
                let stats = {};
                snap.forEach(d => {
                    if(d.id < "2026-01-08") return;
                    d.data().entries.forEach(e => {
                        if(!e.name || e.name.includes("VAGA") || e.name.includes("Free")) return;
                        if(!stats[e.name]) stats[e.name]={g:0,v:0,t:0};
                        if(e.role.includes("Guide")) stats[e.name].g++; else stats[e.name].v++;
                        stats[e.name].t++;
                    });
                });
                let h = `<table style="width:100%"><tr><th>Nome</th><th>Total</th><th>Guias</th><th>GVs</th></tr>`;
                Object.keys(stats).sort().forEach(n => h+=`<tr><td>${n}</td><td>${stats[n].t}</td><td>${stats[n].g}</td><td>${stats[n].v}</td></tr>`);
                div.innerHTML = h+"</table>";
            }
        };
        window.closeAllPanels = () => { document.querySelectorAll('.panel').forEach(p=>p.style.display='none'); document.getElementById('overlay').style.display='none'; };

        function renderCfg() {
            const fields = ['kirraGuides','kirraGVs','kirraRot','mundakaGuides','mundakaGVs','mundakaRot','freelancers'];
            fields.forEach(k => {
                const div = document.getElementById('list'+k.charAt(0).toUpperCase()+k.slice(1));
                if(div) {
                    div.innerHTML = "";
                    (appConfig[k]||[]).forEach((v, i) => {
                        div.innerHTML += `<div class="list-row"><input value="${v}" onchange="appConfig.${k}[${i}]=this.value"><button class="btn-trash" onclick="appConfig.${k}.splice(${i},1); renderCfg()">üóëÔ∏è</button></div>`;
                    });
                    div.innerHTML += `<small style="color:blue;cursor:pointer" onclick="if(!appConfig.${k})appConfig.${k}=[];appConfig.${k}.push('Novo');renderCfg()">+ Adicionar</small>`;
                }
            });
        }

        function getDefaultData() {
            return { kirraGuides: ["Guia K1"], kirraGVs: ["GV K1"], kirraRot: ["Rot K1"], mundakaGuides: ["Guia M1"], mundakaGVs: ["GV M1"], mundakaRot: ["Rot M1"], freelancers: ["Free 1"] };
        }
    </script>
</body>
</html>

